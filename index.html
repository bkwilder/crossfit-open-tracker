<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sunshine City CrossFit - 2025 Open Tracker</title>
<style>
  :root {
    --dark: #2e2e2e;
    --white: #ffffff;
    --teal: #4fa2ac;
    --orange: #ef8421;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #f4f4f4;
    color: var(--dark);
  }

  header {
    background: var(--dark);
    color: var(--white);
    padding: 16px 24px;
    display: flex;
    align-items: center;
    gap: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  }

  header img {
    height: 60px;
    border-radius: 4px;
  }

  header h1 {
    font-size: 1.4rem;
    font-weight: 700;
  }

  header h1 span {
    color: var(--orange);
  }

  nav {
    background: var(--dark);
    display: flex;
    gap: 0;
    border-bottom: 3px solid var(--teal);
    padding: 0 24px;
    overflow-x: auto;
  }

  nav button {
    background: none;
    border: none;
    color: #aaa;
    padding: 12px 20px;
    font-size: 0.95rem;
    font-weight: 600;
    cursor: pointer;
    border-bottom: 3px solid transparent;
    margin-bottom: -3px;
    white-space: nowrap;
    transition: color 0.2s;
  }

  nav button:hover { color: var(--white); }
  nav button.active { color: var(--orange); border-bottom-color: var(--orange); }

  .container {
    max-width: 1100px;
    margin: 24px auto;
    padding: 0 16px;
  }

  .tab-content { display: none; }
  .tab-content.active { display: block; }

  .card {
    background: var(--white);
    border-radius: 8px;
    padding: 24px;
    margin-bottom: 20px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
  }

  .card h2 {
    font-size: 1.2rem;
    margin-bottom: 16px;
    color: var(--dark);
    border-bottom: 2px solid var(--teal);
    padding-bottom: 8px;
  }

  .form-row {
    display: flex;
    gap: 12px;
    margin-bottom: 12px;
    flex-wrap: wrap;
    align-items: flex-end;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .form-group label {
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
    color: #666;
  }

  input, select {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 0.95rem;
  }

  input:focus, select:focus {
    outline: none;
    border-color: var(--teal);
    box-shadow: 0 0 0 2px rgba(79,162,172,0.2);
  }

  button.btn {
    padding: 8px 20px;
    border: none;
    border-radius: 4px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: opacity 0.2s;
  }

  button.btn:hover { opacity: 0.85; }

  .btn-primary { background: var(--teal); color: var(--white); }
  .btn-orange { background: var(--orange); color: var(--white); }
  .btn-danger { background: #d9534f; color: var(--white); }
  .btn-sm { padding: 4px 12px; font-size: 0.8rem; }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
  }

  th {
    background: var(--dark);
    color: var(--white);
    padding: 10px 12px;
    text-align: left;
    font-weight: 600;
    font-size: 0.8rem;
    text-transform: uppercase;
  }

  td {
    padding: 10px 12px;
    border-bottom: 1px solid #eee;
  }

  tr:hover td { background: #f9f9f9; }

  .badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
  }

  .badge-kyle { background: var(--teal); color: var(--white); }
  .badge-pete { background: var(--orange); color: var(--white); }
  .badge-rx { background: var(--dark); color: var(--white); }
  .badge-scaled { background: var(--teal); color: var(--white); }
  .badge-foundations { background: #999; color: var(--white); }
  .badge-paid { background: #5cb85c; color: var(--white); }
  .badge-unpaid { background: #d9534f; color: var(--white); }

  .team-banner {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
  }

  .team-card {
    flex: 1;
    padding: 20px;
    border-radius: 8px;
    color: var(--white);
    text-align: center;
  }

  .team-card.kyle { background: var(--teal); }
  .team-card.pete { background: var(--orange); }

  .team-card h3 { font-size: 1rem; margin-bottom: 4px; text-transform: uppercase; }
  .team-card .score { font-size: 2.5rem; font-weight: 800; }

  .rank-num {
    font-weight: 800;
    font-size: 1.1rem;
  }

  .rank-1 { color: #f5a623; }
  .rank-2 { color: #999; }
  .rank-3 { color: #cd7f32; }

  .costume-check, .score-input, .bonus-input {
    width: 60px;
    text-align: center;
  }

  .score-input { width: 100px; }

  .info-box {
    background: #e8f4f5;
    border-left: 4px solid var(--teal);
    padding: 12px 16px;
    margin-bottom: 16px;
    font-size: 0.85rem;
    line-height: 1.5;
  }

  .info-box.setup-box {
    background: #fff3e0;
    border-left-color: var(--orange);
  }

  .empty-state {
    text-align: center;
    padding: 40px;
    color: #999;
  }

  input[type="number"] { width: 80px; }
  input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }

  .inline-edit {
    padding: 4px 8px;
    border: 1px solid transparent;
    background: transparent;
    border-radius: 3px;
  }
  .inline-edit:hover { border-color: #ddd; }
  .inline-edit:focus { border-color: var(--teal); background: var(--white); }

  .status-bar {
    background: var(--dark);
    color: #aaa;
    padding: 6px 24px;
    font-size: 0.75rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .status-dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 6px;
  }

  .status-dot.connected { background: #5cb85c; }
  .status-dot.disconnected { background: #d9534f; }
  .status-dot.syncing { background: var(--orange); animation: pulse 1s infinite; }

  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }

  .sync-btn {
    background: none;
    border: 1px solid #666;
    color: #aaa;
    padding: 2px 10px;
    border-radius: 3px;
    font-size: 0.75rem;
    cursor: pointer;
  }
  .sync-btn:hover { border-color: var(--teal); color: var(--white); }

  @media (max-width: 700px) {
    .form-row { flex-direction: column; }
    .team-banner { flex-direction: column; }
    header h1 { font-size: 1.1rem; }
    nav button { padding: 10px 14px; font-size: 0.85rem; }
    table { font-size: 0.8rem; }
    td, th { padding: 6px 8px; }
  }
</style>
</head>
<body>

<header>
  <img src="logo.png" alt="Sunshine City CrossFit">
  <h1>2025 CrossFit Open <span>Tracker</span></h1>
</header>

<div class="status-bar">
  <div id="sync-status">
    <span class="status-dot disconnected" id="status-dot"></span>
    <span id="status-text">Not connected — enter your Apps Script URL below</span>
  </div>
  <div>
    <button class="sync-btn" onclick="syncFromCloud()" title="Pull latest data from Google Sheets">Refresh</button>
    <button class="sync-btn" onclick="syncToCloud()" title="Push all local data to Google Sheets">Push All</button>
  </div>
</div>

<nav id="nav">
  <button class="active" data-tab="athletes">Athletes</button>
  <button data-tab="wod1">26.1</button>
  <button data-tab="wod2">26.2</button>
  <button data-tab="wod3">26.3</button>
  <button data-tab="leaderboard">Leaderboard</button>
  <button data-tab="settings">Settings</button>
</nav>

<div class="container">

  <!-- SETTINGS TAB -->
  <div id="settings" class="tab-content">
    <div class="card">
      <h2>Google Sheets Connection</h2>
      <div class="info-box setup-box">
        <strong>Setup instructions:</strong><br>
        1. Create a new Google Sheet<br>
        2. Go to <strong>Extensions &gt; Apps Script</strong><br>
        3. Paste the code from <code>apps-script.js</code> (included in this project)<br>
        4. Click <strong>Deploy &gt; New deployment</strong><br>
        5. Choose <strong>Web app</strong>, set "Who has access" to <strong>Anyone</strong><br>
        6. Click <strong>Deploy</strong> and copy the URL<br>
        7. Paste the URL below and click Save
      </div>
      <div class="form-row">
        <div class="form-group" style="flex:1">
          <label>Apps Script Web App URL</label>
          <input type="text" id="api-url" placeholder="https://script.google.com/macros/s/...../exec" style="width:100%">
        </div>
        <div class="form-group">
          <label>&nbsp;</label>
          <button class="btn btn-primary" onclick="saveApiUrl()">Save &amp; Connect</button>
        </div>
      </div>
      <div id="connection-test" style="margin-top:12px;font-size:0.85rem"></div>
    </div>
    <div class="card">
      <h2>Data Management</h2>
      <div class="form-row">
        <button class="btn btn-orange" onclick="exportData()">Export JSON Backup</button>
        <div class="form-group">
          <label>Import JSON Backup</label>
          <input type="file" id="import-file" accept=".json" onchange="importData(event)">
        </div>
      </div>
    </div>
  </div>

  <!-- ATHLETES TAB -->
  <div id="athletes" class="tab-content active">
    <div class="card">
      <h2>Add Athlete</h2>
      <div class="form-row">
        <div class="form-group">
          <label>Name</label>
          <input type="text" id="athlete-name" placeholder="Athlete name">
        </div>
        <div class="form-group">
          <label>Team</label>
          <select id="athlete-team">
            <option value="kyle">Team Kyle</option>
            <option value="pete">Team Pete</option>
          </select>
        </div>
        <div class="form-group">
          <label>Paid</label>
          <select id="athlete-paid">
            <option value="yes">Yes</option>
            <option value="no">No</option>
          </select>
        </div>
        <div class="form-group">
          <label>&nbsp;</label>
          <button class="btn btn-primary" onclick="addAthlete()">Add Athlete</button>
        </div>
      </div>
    </div>
    <div class="card">
      <h2>Roster</h2>
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Team</th>
            <th>Paid</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="athletes-table"></tbody>
      </table>
      <div id="athletes-empty" class="empty-state">No athletes added yet.</div>
    </div>
  </div>

  <!-- WOD TABS (26.1, 26.2, 26.3) -->
  <div id="wod1" class="tab-content"></div>
  <div id="wod2" class="tab-content"></div>
  <div id="wod3" class="tab-content"></div>

  <!-- LEADERBOARD TAB -->
  <div id="leaderboard" class="tab-content"></div>

</div>

<script>
// ── Config ──
const DATA_KEY = 'sccf_open_2025';
const API_KEY  = 'sccf_api_url';

let apiUrl = localStorage.getItem(API_KEY) || '';

// Populate the settings field on load
window.addEventListener('DOMContentLoaded', () => {
  document.getElementById('api-url').value = apiUrl;
  if (apiUrl) updateStatus('syncing', 'Connecting...');
  init();
});

// ── Status bar ──
function updateStatus(state, text) {
  const dot = document.getElementById('status-dot');
  const txt = document.getElementById('status-text');
  dot.className = 'status-dot ' + state;
  txt.textContent = text;
}

// ── Data Layer (localStorage as primary cache) ──
function loadData() {
  const d = localStorage.getItem(DATA_KEY);
  return d ? JSON.parse(d) : { athletes: [], scores: { wod1: {}, wod2: {}, wod3: {} } };
}

function saveData(data) {
  localStorage.setItem(DATA_KEY, JSON.stringify(data));
}

// ── Google Sheets API ──
function getApiUrl() {
  return localStorage.getItem(API_KEY) || '';
}

function saveApiUrl() {
  const url = document.getElementById('api-url').value.trim();
  localStorage.setItem(API_KEY, url);
  apiUrl = url;
  const testDiv = document.getElementById('connection-test');

  if (!url) {
    updateStatus('disconnected', 'Not connected');
    testDiv.innerHTML = '<span style="color:#d9534f">URL cleared. Using local storage only.</span>';
    return;
  }

  testDiv.innerHTML = 'Testing connection...';
  updateStatus('syncing', 'Connecting...');

  fetch(url + '?action=getAll')
    .then(r => r.json())
    .then(data => {
      testDiv.innerHTML = '<span style="color:#5cb85c">Connected! Found ' + (data.athletes?.length || 0) + ' athletes in the sheet.</span>';
      updateStatus('connected', 'Connected to Google Sheets');
      if (data.athletes && data.athletes.length > 0) {
        saveData(data);
        renderAll();
      }
    })
    .catch(err => {
      testDiv.innerHTML = '<span style="color:#d9534f">Connection failed: ' + err.message + '</span>';
      updateStatus('disconnected', 'Connection failed');
    });
}

async function apiPost(action, data) {
  const url = getApiUrl();
  if (!url) return;

  updateStatus('syncing', 'Saving...');
  try {
    await fetch(url, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ action, data })
    });
    // no-cors means we can't read the response, but the request goes through
    updateStatus('connected', 'Saved — ' + new Date().toLocaleTimeString());
  } catch (err) {
    updateStatus('disconnected', 'Save failed: ' + err.message);
  }
}

async function syncFromCloud() {
  const url = getApiUrl();
  if (!url) {
    updateStatus('disconnected', 'No API URL configured — go to Settings');
    return;
  }

  updateStatus('syncing', 'Pulling data...');
  try {
    const r = await fetch(url + '?action=getAll');
    const data = await r.json();
    saveData(data);
    renderAll();
    updateStatus('connected', 'Refreshed — ' + new Date().toLocaleTimeString());
  } catch (err) {
    updateStatus('disconnected', 'Refresh failed: ' + err.message);
  }
}

async function syncToCloud() {
  const url = getApiUrl();
  if (!url) {
    updateStatus('disconnected', 'No API URL configured — go to Settings');
    return;
  }

  updateStatus('syncing', 'Pushing all data...');
  const data = loadData();
  try {
    await fetch(url, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'text/plain' },
      body: JSON.stringify({ action: 'saveAllData', data })
    });
    updateStatus('connected', 'Pushed all data — ' + new Date().toLocaleTimeString());
  } catch (err) {
    updateStatus('disconnected', 'Push failed: ' + err.message);
  }
}

// ── Init ──
async function init() {
  renderAll();
  if (apiUrl) {
    try {
      const r = await fetch(apiUrl + '?action=getAll');
      const data = await r.json();
      if (data.athletes && data.athletes.length > 0) {
        saveData(data);
        renderAll();
      }
      updateStatus('connected', 'Connected to Google Sheets');
    } catch {
      updateStatus('disconnected', 'Could not reach Google Sheets');
    }
  }
}

// ── Tab Navigation ──
document.querySelectorAll('#nav button').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('#nav button').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById(btn.dataset.tab).classList.add('active');
    renderAll();
  });
});

// ── Athletes ──
function addAthlete() {
  const name = document.getElementById('athlete-name').value.trim();
  if (!name) return;
  const team = document.getElementById('athlete-team').value;
  const paid = document.getElementById('athlete-paid').value === 'yes';
  const data = loadData();
  const athlete = { id: Date.now().toString(), name, team, paid };
  data.athletes.push(athlete);
  saveData(data);
  document.getElementById('athlete-name').value = '';
  renderAll();
  apiPost('addAthlete', athlete);
}

document.getElementById('athlete-name').addEventListener('keydown', e => {
  if (e.key === 'Enter') addAthlete();
});

function removeAthlete(id) {
  if (!confirm('Remove this athlete? Their scores will be deleted.')) return;
  const data = loadData();
  data.athletes = data.athletes.filter(a => a.id !== id);
  ['wod1','wod2','wod3'].forEach(w => delete data.scores[w][id]);
  saveData(data);
  renderAll();
  apiPost('removeAthlete', { id });
}

function togglePaid(id) {
  const data = loadData();
  const a = data.athletes.find(x => x.id === id);
  if (a) {
    a.paid = !a.paid;
    saveData(data);
    renderAll();
    apiPost('updateAthlete', { id, paid: a.paid });
  }
}

function toggleTeam(id) {
  const data = loadData();
  const a = data.athletes.find(x => x.id === id);
  if (a) {
    a.team = a.team === 'kyle' ? 'pete' : 'kyle';
    saveData(data);
    renderAll();
    apiPost('updateAthlete', { id, team: a.team });
  }
}

function renderAthletes() {
  const data = loadData();
  const tbody = document.getElementById('athletes-table');
  const empty = document.getElementById('athletes-empty');

  if (data.athletes.length === 0) {
    tbody.innerHTML = '';
    empty.style.display = 'block';
    return;
  }

  empty.style.display = 'none';
  const sorted = [...data.athletes].sort((a, b) => {
    if (a.team !== b.team) return a.team === 'kyle' ? -1 : 1;
    return a.name.localeCompare(b.name);
  });

  tbody.innerHTML = sorted.map(a => `
    <tr>
      <td><strong>${esc(a.name)}</strong></td>
      <td>
        <span class="badge badge-${a.team}" style="cursor:pointer" onclick="toggleTeam('${a.id}')" title="Click to switch team">
          Team ${a.team.charAt(0).toUpperCase() + a.team.slice(1)}
        </span>
      </td>
      <td>
        <span class="badge ${a.paid ? 'badge-paid' : 'badge-unpaid'}" style="cursor:pointer" onclick="togglePaid('${a.id}')" title="Click to toggle">
          ${a.paid ? 'Paid' : 'Unpaid'}
        </span>
      </td>
      <td>
        <button class="btn btn-danger btn-sm" onclick="removeAthlete('${a.id}')">Remove</button>
      </td>
    </tr>
  `).join('');
}

// ── WOD Scoring ──
function getPaidAthletes() {
  return loadData().athletes.filter(a => a.paid);
}

function renderWod(wodKey, wodLabel) {
  const container = document.getElementById(wodKey);
  const paid = getPaidAthletes();
  const data = loadData();
  const scores = data.scores[wodKey] || {};

  if (paid.length === 0) {
    container.innerHTML = `
      <div class="card">
        <h2>${wodLabel} Scoring</h2>
        <div class="empty-state">No paid athletes yet. Add athletes and mark them as paid to enter scores.</div>
      </div>`;
    return;
  }

  const ranked = rankAthletes(paid, scores);

  container.innerHTML = `
    <div class="card">
      <h2>${wodLabel} Scoring</h2>
      <div class="info-box">
        <strong>How scoring works:</strong> Enter each athlete's score (reps, time, etc.).
        Select their division (RX &gt; Scaled &gt; Foundations). Athletes are ranked within division by score (highest first),
        with RX ranked above Scaled above Foundations. Points = total participants + 1 &minus; place.
        Bonus points from costume and spirit are added on top.
      </div>
      <div style="overflow-x:auto">
      <table>
        <thead>
          <tr>
            <th>Rank</th>
            <th>Pts</th>
            <th>Name</th>
            <th>Team</th>
            <th>Score</th>
            <th>Division</th>
            <th title="Costume bonus (+3 pts)">Costume</th>
            <th title="Additional bonus points">Bonus</th>
          </tr>
        </thead>
        <tbody>
          ${ranked.map((r, i) => {
            const s = scores[r.id] || {};
            const rankClass = i < 3 ? `rank-${i+1}` : '';
            return `
            <tr>
              <td><span class="rank-num ${rankClass}">${s.score != null && s.score !== '' ? i + 1 : '-'}</span></td>
              <td><strong>${r.points || '-'}</strong></td>
              <td>${esc(r.name)}</td>
              <td><span class="badge badge-${r.team}">Team ${r.team.charAt(0).toUpperCase() + r.team.slice(1)}</span></td>
              <td><input type="text" class="inline-edit score-input" value="${s.score ?? ''}"
                    data-wod="${wodKey}" data-id="${r.id}" data-field="score"
                    onchange="updateScore(this)" placeholder="e.g. 150"></td>
              <td><select class="inline-edit" data-wod="${wodKey}" data-id="${r.id}" data-field="division" onchange="updateScore(this)">
                    <option value="rx" ${(s.division||'rx')==='rx'?'selected':''}>RX</option>
                    <option value="scaled" ${(s.division)==='scaled'?'selected':''}>Scaled</option>
                    <option value="foundations" ${(s.division)==='foundations'?'selected':''}>Foundations</option>
                  </select></td>
              <td style="text-align:center"><input type="checkbox" ${s.costume?'checked':''}
                    data-wod="${wodKey}" data-id="${r.id}" data-field="costume"
                    onchange="updateScore(this)"></td>
              <td><input type="number" class="inline-edit bonus-input" value="${s.bonus||0}" min="0"
                    data-wod="${wodKey}" data-id="${r.id}" data-field="bonus"
                    onchange="updateScore(this)"></td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
      </div>
    </div>`;
}

function updateScore(el) {
  const data = loadData();
  const { wod, id, field } = el.dataset;
  if (!data.scores[wod]) data.scores[wod] = {};
  if (!data.scores[wod][id]) data.scores[wod][id] = {};

  if (field === 'costume') {
    data.scores[wod][id][field] = el.checked;
  } else if (field === 'bonus') {
    data.scores[wod][id][field] = parseInt(el.value) || 0;
  } else if (field === 'score') {
    data.scores[wod][id][field] = el.value.trim();
  } else {
    data.scores[wod][id][field] = el.value;
  }

  saveData(data);

  // Sync this score to the sheet
  const s = data.scores[wod][id];
  apiPost('saveScore', {
    athleteId: id,
    wod,
    score: s.score || '',
    division: s.division || 'rx',
    costume: s.costume || false,
    bonus: s.bonus || 0
  });

  // Re-render to update ranks
  const wodLabel = wod === 'wod1' ? '26.1' : wod === 'wod2' ? '26.2' : '26.3';
  renderWod(wod, wodLabel);
}

function rankAthletes(athletes, scores) {
  const divOrder = { rx: 0, scaled: 1, foundations: 2 };

  const list = athletes.map(a => {
    const s = scores[a.id] || {};
    const scoreVal = parseScore(s.score);
    return {
      ...a,
      score: s.score,
      scoreVal,
      division: s.division || 'rx',
      costume: s.costume || false,
      bonus: parseInt(s.bonus) || 0,
      hasScore: scoreVal !== null
    };
  });

  const scored = list.filter(a => a.hasScore);
  const unscored = list.filter(a => !a.hasScore);

  scored.sort((a, b) => {
    const dA = divOrder[a.division] ?? 1;
    const dB = divOrder[b.division] ?? 1;
    if (dA !== dB) return dA - dB;
    return b.scoreVal - a.scoreVal;
  });

  const total = scored.length;
  scored.forEach((a, i) => {
    const placePoints = total - i;
    const costumePoints = a.costume ? 3 : 0;
    a.points = placePoints + costumePoints + a.bonus;
  });

  unscored.forEach(a => { a.points = 0; });

  return [...scored, ...unscored];
}

function parseScore(val) {
  if (val == null || val === '') return null;
  const timeMatch = val.toString().match(/^(\d+):(\d{2})$/);
  if (timeMatch) {
    const totalSec = parseInt(timeMatch[1]) * 60 + parseInt(timeMatch[2]);
    return -totalSec;
  }
  const num = parseFloat(val);
  return isNaN(num) ? null : num;
}

// ── Leaderboard ──
function renderLeaderboard() {
  const container = document.getElementById('leaderboard');
  const data = loadData();
  const paid = getPaidAthletes();

  if (paid.length === 0) {
    container.innerHTML = `
      <div class="card">
        <h2>Overall Leaderboard</h2>
        <div class="empty-state">No paid athletes yet.</div>
      </div>`;
    return;
  }

  const wodKeys = ['wod1', 'wod2', 'wod3'];
  const athletePoints = {};

  paid.forEach(a => {
    athletePoints[a.id] = { name: a.name, team: a.team, total: 0, wods: {} };
  });

  wodKeys.forEach(wk => {
    const scores = data.scores[wk] || {};
    const ranked = rankAthletes(paid, scores);
    ranked.forEach(r => {
      if (athletePoints[r.id]) {
        athletePoints[r.id].wods[wk] = r.points || 0;
        athletePoints[r.id].total += r.points || 0;
      }
    });
  });

  const individuals = Object.values(athletePoints).sort((a, b) => b.total - a.total);

  let teamKyle = 0, teamPete = 0;
  individuals.forEach(a => {
    if (a.team === 'kyle') teamKyle += a.total;
    else teamPete += a.total;
  });

  container.innerHTML = `
    <div class="team-banner">
      <div class="team-card kyle">
        <h3>Team Kyle</h3>
        <div class="score">${teamKyle}</div>
        <div>Total Points</div>
      </div>
      <div class="team-card pete">
        <h3>Team Pete</h3>
        <div class="score">${teamPete}</div>
        <div>Total Points</div>
      </div>
    </div>

    <div class="card">
      <h2>Individual Rankings</h2>
      <div style="overflow-x:auto">
      <table>
        <thead>
          <tr>
            <th>Rank</th>
            <th>Athlete</th>
            <th>Team</th>
            <th>26.1</th>
            <th>26.2</th>
            <th>26.3</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          ${individuals.map((a, i) => {
            const rankClass = i < 3 ? `rank-${i+1}` : '';
            return `
            <tr>
              <td><span class="rank-num ${rankClass}">${i + 1}</span></td>
              <td><strong>${esc(a.name)}</strong></td>
              <td><span class="badge badge-${a.team}">Team ${a.team.charAt(0).toUpperCase() + a.team.slice(1)}</span></td>
              <td>${a.wods.wod1 || '-'}</td>
              <td>${a.wods.wod2 || '-'}</td>
              <td>${a.wods.wod3 || '-'}</td>
              <td><strong>${a.total}</strong></td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
      </div>
    </div>

    <div class="card">
      <h2>Team Breakdown</h2>
      <div style="overflow-x:auto">
      <table>
        <thead>
          <tr>
            <th>Team</th>
            <th>26.1</th>
            <th>26.2</th>
            <th>26.3</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          ${['kyle','pete'].map(team => {
            const members = individuals.filter(a => a.team === team);
            const w1 = members.reduce((s, a) => s + (a.wods.wod1||0), 0);
            const w2 = members.reduce((s, a) => s + (a.wods.wod2||0), 0);
            const w3 = members.reduce((s, a) => s + (a.wods.wod3||0), 0);
            const tot = w1 + w2 + w3;
            return `
            <tr>
              <td><span class="badge badge-${team}" style="font-size:0.9rem;padding:4px 12px">Team ${team.charAt(0).toUpperCase()+team.slice(1)}</span></td>
              <td>${w1}</td>
              <td>${w2}</td>
              <td>${w3}</td>
              <td><strong>${tot}</strong></td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
      </div>
    </div>
  `;
}

// ── Export / Import ──
function exportData() {
  const data = loadData();
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'sccf-open-2025-backup.json';
  a.click();
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = JSON.parse(e.target.result);
      if (data.athletes && data.scores) {
        saveData(data);
        renderAll();
        alert('Data imported successfully! (' + data.athletes.length + ' athletes)');
      } else {
        alert('Invalid backup file format.');
      }
    } catch {
      alert('Could not parse the file.');
    }
  };
  reader.readAsText(file);
}

// ── Helpers ──
function esc(str) {
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

function renderAll() {
  renderAthletes();
  renderWod('wod1', '26.1');
  renderWod('wod2', '26.2');
  renderWod('wod3', '26.3');
  renderLeaderboard();
}

renderAll();
</script>

</body>
</html>
