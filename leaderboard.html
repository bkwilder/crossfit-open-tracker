<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sunshine City CrossFit - 2026 Open Leaderboard</title>
<style>
  :root {
    --dark: #2e2e2e;
    --white: #ffffff;
    --teal: #4fa2ac;
    --orange: #ef8421;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #f4f4f4;
    color: var(--dark);
  }

  header {
    background: var(--dark);
    color: var(--white);
    padding: 16px 24px;
    display: flex;
    align-items: center;
    gap: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  }

  header img {
    height: 60px;
    border-radius: 4px;
  }

  header h1 {
    font-size: 1.4rem;
    font-weight: 700;
  }

  header h1 span {
    color: var(--orange);
  }

  .status-bar {
    background: var(--dark);
    color: #aaa;
    padding: 6px 24px;
    font-size: 0.75rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 3px solid var(--teal);
  }

  .status-dot {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 6px;
  }

  .status-dot.loading { background: var(--orange); animation: pulse 1s infinite; }
  .status-dot.connected { background: #5cb85c; }
  .status-dot.error { background: #d9534f; }

  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.3; } }

  .refresh-btn {
    background: none;
    border: 1px solid #666;
    color: #aaa;
    padding: 2px 10px;
    border-radius: 3px;
    font-size: 0.75rem;
    cursor: pointer;
  }
  .refresh-btn:hover { border-color: var(--teal); color: var(--white); }

  .container {
    max-width: 1100px;
    margin: 24px auto;
    padding: 0 16px;
  }

  .card {
    background: var(--white);
    border-radius: 8px;
    padding: 24px;
    margin-bottom: 20px;
    box-shadow: 0 1px 4px rgba(0,0,0,0.1);
  }

  .card h2 {
    font-size: 1.2rem;
    margin-bottom: 16px;
    color: var(--dark);
    border-bottom: 2px solid var(--teal);
    padding-bottom: 8px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
  }

  th {
    background: var(--dark);
    color: var(--white);
    padding: 10px 12px;
    text-align: left;
    font-weight: 600;
    font-size: 0.8rem;
    text-transform: uppercase;
  }

  td {
    padding: 10px 12px;
    border-bottom: 1px solid #eee;
  }

  tr:hover td { background: #f9f9f9; }

  .badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 10px;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
  }

  .badge-kyle { background: var(--teal); color: var(--white); }
  .badge-pete { background: var(--orange); color: var(--white); }

  .team-banner {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
  }

  .team-card {
    flex: 1;
    padding: 20px;
    border-radius: 8px;
    color: var(--white);
    text-align: center;
  }

  .team-card.kyle { background: var(--teal); }
  .team-card.pete { background: var(--orange); }

  .team-card h3 { font-size: 1rem; margin-bottom: 4px; text-transform: uppercase; }
  .team-card .score { font-size: 2.5rem; font-weight: 800; }
  .team-card .leader-tag {
    display: inline-block;
    margin-top: 6px;
    background: rgba(255,255,255,0.25);
    border-radius: 10px;
    padding: 2px 10px;
    font-size: 0.75rem;
    font-weight: 700;
  }

  .rank-num {
    font-weight: 800;
    font-size: 1.1rem;
  }

  .rank-1 { color: #f5a623; }
  .rank-2 { color: #999; }
  .rank-3 { color: #cd7f32; }

  .empty-state {
    text-align: center;
    padding: 40px;
    color: #999;
  }

  .loading-spinner {
    text-align: center;
    padding: 60px;
    color: #999;
    font-size: 1rem;
  }

  .loading-spinner::after {
    content: '';
    display: block;
    width: 36px;
    height: 36px;
    border: 3px solid #eee;
    border-top-color: var(--teal);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 16px auto 0;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  @media (max-width: 700px) {
    .team-banner { flex-direction: column; }
    header h1 { font-size: 1.1rem; }
    table { font-size: 0.8rem; }
    td, th { padding: 6px 8px; }
  }
</style>
</head>
<body>

<header>
  <img src="logo.png" alt="Sunshine City CrossFit">
  <h1>2026 CrossFit Open <span>Leaderboard</span></h1>
</header>

<div class="status-bar">
  <div>
    <span class="status-dot loading" id="status-dot"></span>
    <span id="status-text">Loading...</span>
  </div>
  <button class="refresh-btn" onclick="loadLeaderboard()">Refresh</button>
</div>

<div class="container" id="leaderboard-container">
  <div class="loading-spinner">Loading leaderboard</div>
</div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbwBbiUd_c32AaUouQ67vZ50o6zX29K_zaG3VT8-UPYNYP3lYTdQ2rTMcIRxKN-07U0J/exec';

function esc(str) {
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

function parseScore(val) {
  if (val == null || val === '') return null;
  const timeMatch = val.toString().match(/^(\d+):(\d{2})$/);
  if (timeMatch) {
    const totalSec = parseInt(timeMatch[1]) * 60 + parseInt(timeMatch[2]);
    return -totalSec;
  }
  const num = parseFloat(val);
  return isNaN(num) ? null : num;
}

function rankAthletes(athletes, scores) {
  const divOrder = { rx: 0, scaled: 1, foundations: 2 };
  const list = athletes.map(a => {
    const s = scores[a.id] || {};
    const scoreVal = parseScore(s.score);
    return {
      ...a,
      score: s.score,
      scoreVal,
      division: s.division || 'rx',
      costume: s.costume || false,
      bonus: parseInt(s.bonus) || 0,
      hasScore: scoreVal !== null
    };
  });

  const scored = list.filter(a => a.hasScore);
  const unscored = list.filter(a => !a.hasScore);

  scored.sort((a, b) => {
    const dA = divOrder[a.division] ?? 1;
    const dB = divOrder[b.division] ?? 1;
    if (dA !== dB) return dA - dB;
    return b.scoreVal - a.scoreVal;
  });

  const total = scored.length;
  scored.forEach((a, i) => {
    a.points = (total - i) + (a.costume ? 3 : 0) + a.bonus;
  });
  unscored.forEach(a => { a.points = 0; });

  return [...scored, ...unscored];
}

function renderLeaderboard(data) {
  const paid = data.athletes.filter(a => a.paid);
  const container = document.getElementById('leaderboard-container');

  if (paid.length === 0) {
    container.innerHTML = '<div class="card"><div class="empty-state">No scores posted yet. Check back soon!</div></div>';
    return;
  }

  const wodKeys = ['wod1', 'wod2', 'wod3'];
  const athletePoints = {};
  paid.forEach(a => {
    athletePoints[a.id] = { name: a.name, team: a.team, total: 0, wods: {} };
  });

  wodKeys.forEach(wk => {
    const scores = data.scores[wk] || {};
    const ranked = rankAthletes(paid, scores);
    ranked.forEach(r => {
      if (athletePoints[r.id]) {
        athletePoints[r.id].wods[wk] = r.points || 0;
        athletePoints[r.id].total += r.points || 0;
      }
    });
  });

  const individuals = Object.values(athletePoints).sort((a, b) => b.total - a.total);

  let teamKyle = 0, teamPete = 0;
  individuals.forEach(a => {
    if (a.team === 'kyle') teamKyle += a.total;
    else teamPete += a.total;
  });

  const kyleLeading = teamKyle >= teamPete;

  container.innerHTML = `
    <div class="team-banner">
      <div class="team-card kyle">
        <h3>Team Kyle</h3>
        <div class="score">${teamKyle}</div>
        <div>Total Points</div>
        ${kyleLeading && teamKyle !== teamPete ? '<div class="leader-tag">Leading</div>' : ''}
      </div>
      <div class="team-card pete">
        <h3>Team Pete</h3>
        <div class="score">${teamPete}</div>
        <div>Total Points</div>
        ${!kyleLeading && teamKyle !== teamPete ? '<div class="leader-tag">Leading</div>' : ''}
      </div>
    </div>

    <div class="card">
      <h2>Individual Rankings</h2>
      <div style="overflow-x:auto">
      <table>
        <thead>
          <tr>
            <th>Rank</th>
            <th>Athlete</th>
            <th>Team</th>
            <th>26.1</th>
            <th>26.2</th>
            <th>26.3</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          ${individuals.map((a, i) => {
            const rankClass = i < 3 ? `rank-${i+1}` : '';
            return `
            <tr>
              <td><span class="rank-num ${rankClass}">${i + 1}</span></td>
              <td><strong>${esc(a.name)}</strong></td>
              <td><span class="badge badge-${a.team}">Team ${a.team.charAt(0).toUpperCase() + a.team.slice(1)}</span></td>
              <td>${a.wods.wod1 || '-'}</td>
              <td>${a.wods.wod2 || '-'}</td>
              <td>${a.wods.wod3 || '-'}</td>
              <td><strong>${a.total}</strong></td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
      </div>
    </div>

    <div class="card">
      <h2>Team Breakdown</h2>
      <div style="overflow-x:auto">
      <table>
        <thead>
          <tr>
            <th>Team</th>
            <th>26.1</th>
            <th>26.2</th>
            <th>26.3</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          ${['kyle','pete'].map(team => {
            const members = individuals.filter(a => a.team === team);
            const w1 = members.reduce((s, a) => s + (a.wods.wod1||0), 0);
            const w2 = members.reduce((s, a) => s + (a.wods.wod2||0), 0);
            const w3 = members.reduce((s, a) => s + (a.wods.wod3||0), 0);
            const tot = w1 + w2 + w3;
            return `
            <tr>
              <td><span class="badge badge-${team}" style="font-size:0.9rem;padding:4px 12px">Team ${team.charAt(0).toUpperCase()+team.slice(1)}</span></td>
              <td>${w1}</td>
              <td>${w2}</td>
              <td>${w3}</td>
              <td><strong>${tot}</strong></td>
            </tr>`;
          }).join('')}
        </tbody>
      </table>
      </div>
    </div>
  `;
}

async function loadLeaderboard() {
  const dot = document.getElementById('status-dot');
  const txt = document.getElementById('status-text');
  dot.className = 'status-dot loading';
  txt.textContent = 'Loading...';

  try {
    const r = await fetch(API_URL + '?action=getAll');
    const data = await r.json();
    renderLeaderboard(data);
    dot.className = 'status-dot connected';
    txt.textContent = 'Updated ' + new Date().toLocaleTimeString();
  } catch (err) {
    dot.className = 'status-dot error';
    txt.textContent = 'Could not load data â€” ' + err.message;
    if (document.getElementById('leaderboard-container').querySelector('.loading-spinner')) {
      document.getElementById('leaderboard-container').innerHTML =
        '<div class="card"><div class="empty-state">Unable to load leaderboard. Please try refreshing.</div></div>';
    }
  }
}

// Load on page open, then auto-refresh every 2 minutes
loadLeaderboard();
setInterval(loadLeaderboard, 120000);
</script>

</body>
</html>
